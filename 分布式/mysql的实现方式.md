# Mysql

### 分库分表带来的场景？

### 分库分表带来的问题？

## 什么是分库分表？

一个数据库一张表分成N小表

一个数据库分成多个数据库

## 为什么需要分库分表？

业务越来越大，单表数据超出了数据库支持的容量？

持久化磁盘IO， 传统的数据库性能瓶颈。

业务越大，单表数据越大，并发越大。

改变程序。数据库下刀子优化。

1.换数据库 （缓存）

2.sql， 索引， 字段优化

3.读写分离。  （业务有关优化）

4.分库分表 （业务）

5.分区

## 分库分表常见的方式

### 垂直拆分

垂直拆分，原本一个系统在一个数据库中，我们把它按照业务拆封到不同的数据库中。比如一个电商网站有个单库。后来由于数据量大了以后，我们把数据库按照业务，会员，订单，商品，拆封成三个数据库。

通俗的说法叫做"大表拆小表"，拆分是基于关系型数据库列（字段）进行拆分。就是对表的结构拆分

**特点：**

1. 每个库（表）的结构都不一样
2. 每个库（表）**的数据都至少有一列一样**
3. 每个库（表）都是全量数据

**优点：**

1. 拆分后业务清晰（专库专用）
2. 实现动静分离，冷热数据分离设计实现。冷库发表说说信息，热库：说说点赞评论
3. 数据维护简单，按业务不同业务放在不同机器上

**缺点：**

1. 如果单表的数据量大，读写压力大
2. 受某种业务来决定，或者被限制。也就是一个业务往往会影响到数据库瓶颈（性能问题）
3. 部分业务无法关联join，只能通过**java程序**接口去调用，提供了开发的复杂度。（商品，订单，会员信息），关联查询变成两次单读查询

### 水平拆分

以某个字段按照一定规律（取模）讲一个表的数据分到多个库中，内容拆分。

**特点：**

1. 每个库（表）的结构都一样
2. 每个库（表）的数据都不一样
3. 每个库（表）的并集是全量数据

**优点：**

1. 单库（表）的数据保持在一定的量（减少），有助于性能的提高
2. 提高了系统的稳定性和负载能力。
3. 切分的表结构相同，程序改造比较少。

**缺点：**

1. 数据的扩容难度维护量大。 %x，每次都要%x
2. 拆分规则很难抽象出来。%x x的数量会随着机器的增加而增加。
3. 分片事务的一致性的问题部分业务无法关联join，只能通过java程序接口调用

### 分库分表

垂直分库水平分表

### 分库分表之后带来的问题

**读写分离**：带来的问题： **主从同步**，**一致性问题**，**网络延迟问题**

**分库分表：**增加我们维护的成本， **分布式事务（跨库事务）**，跨库join， **分布式全局唯一ID**

1. **分布式事务（跨库事务）**
2. 跨库join
3. **分布式全局唯一ID**     在大表做水平分表时，就不能使用自增Id，因为Insert的记录插入到哪个分表依分表规则判定决定，若是自增Id，各个分表中Id就会重复，在做查询、删除时就会有异常。

### 分库分表算法

- 取模（Hash）

取模（Hash）通过userid用户表字段值进行123%3=xxx 数据分散均衡，避免数据热点，一致性hash（扩容需要O（n））

- 范围区分（range）

按月，按省，如果有A, B, C, D数据库，A的性能比较厉害，B的性能还行， C的性能不错， D的性能不错。我们就要A分担的数据多一点，B分担的较多一点，C分担一点。   **热点数据**

- 预定义（List）

在一开始就预估了最高流量，给分布式数据库增加对应的数量。但是成本太大













